<div
  class="page-banner-wrap bg-cover"
  style="background-image: url('assets/img/page-banner.jpg')">
  <div class="container">
    <div class="row">
      <div class="col-12 col-lg-12">
        <div class="page-heading text-white">
          <h1>Contact Us</h1>
        </div>
        <div class="breadcrumb-wrap">
          <nav>
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="index.html">Home</a></li>
              <li class="breadcrumb-item active" aria-current="page">
                about us
              </li>
            </ol>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="contact-us-wrapper section-padding">
  <div class="container">
    <div class="row eq-height">
      <div class="col-lg-8 col-12">
        <div class="contact-form">
          <h2>Get in Touch</h2>
          <form action="" method="POST" class="row" id="contact-form">
            <div class="col-md-6 col-12">
              <div class="single-personal-info">
                <input type="text" name="name" placeholder="Name" required />
              </div>
            </div>
            <div class="col-md-6 col-12">
              <div class="single-personal-info">
                <input type="email" name="email" placeholder="Email" required />
              </div>
            </div>
            <div class="col-md-6 col-12">
              <div class="single-personal-info">
                <input type="text" name="phone" placeholder="Number" required />
              </div>
            </div>
            <div class="col-md-6 col-12">
              <div class="single-personal-info">
                <input
                  type="text"
                  name="subject"
                  placeholder="Subject"
                  required />
              </div>
            </div>
            <div class="col-md-12 col-12">
              <div class="single-personal-info">
                <textarea
                  name="message"
                  placeholder="message"
                  required></textarea>
              </div>
            </div>
            <!-- Honeypot field: hidden from human users; bots often fill it -->
            <div class="col-md-12 col-12" style="display: none">
              <div class="single-personal-info">
                <input
                  type="text"
                  name="company"
                  id="company_hpot"
                  autocomplete="off"
                  tabindex="-1" />
              </div>
            </div>
            <div class="col-md-12">
              <input
                type="hidden"
                name="recaptcha_token"
                id="recaptcha_token" />
            </div>
            <div class="col-md-12 text-center">
              <button class="submit-btn" type="submit">Send Message</button>
            </div>
            <div class="col-md-12 text-center mt-2">
              <div
                class="recaptcha-disclaimer"
                style="font-size: 12px; margin-top: 10px; color: #666">
                This site is protected by reCAPTCHA and the Google
                <a
                  href="https://policies.google.com/privacy"
                  target="_blank"
                  rel="noopener"
                  >Privacy Policy</a
                >
                and
                <a
                  href="https://policies.google.com/terms"
                  target="_blank"
                  rel="noopener"
                  >Terms of Service</a
                >
                apply.
              </div>
            </div>
          </form>
        </div>
      </div>
      <div class="col-lg-4 col-12">
        <div class="contact-us-sidebar mt-5 mt-lg-0">
          <div class="contact-info">
            <h2>CONTACT INFO</h2>
            <div class="single-info">
              <div class="icon">
                <i class="flaticon-email"></i>
              </div>
              <div class="text">
                <span>Email Us</span>
                <p class="h6">footnoteconsults@gmail.com</p>
              </div>
            </div>
            <div class="single-info">
              <div class="icon">
                <i class="flaticon-phone-call-1"></i>
              </div>
              <div class="text">
                <span>Call Us</span>
                <p class="h6">+256 700 372 968</p>
              </div>
            </div>
            <div class="single-info">
              <div class="icon">
                <i class="flaticon-pin"></i>
              </div>
              <div class="text">
                <span>Location</span>
                <p class="h6">UMF Building, Sir Apollo Kaggwa Rd.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="contact-map-wrap">
  <div id="map">
    <iframe
      loading="lazy"
      src="https://maps.google.com/maps?q=Makerere-Kikoni%2C%20UMI%2Ckampala%2C%20Uganda&amp;t=m&amp;z=10&amp;output=embed&amp;iwloc=near"
      title="Makerere-Kikoni, UMI,kampala, Uganda"
      aria-label="Makerere-Kikoni, UMI,kampala, Uganda"
      style="border: 0; width: 100%"
      allowfullscreen=""
      aria-hidden="false"
      tabindex="0"></iframe>
  </div>
</div>

<!-- /Contact Section -->
<!-- Load reCAPTCHA v3 with explicit render param for this site key -->
<script src="https://www.google.com/recaptcha/api.js?render=6LfhOiAsAAAAAAD5fU4kNUvIdl_R0_JTZ9W-eocq"></script>
<script
  type="text/javascript"
  src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script type="text/javascript">
  (function () {
    emailjs.init("wvcBgl_07C543imsh");
  })();

  // Validation utilities
  function isValidEmail(email) {
    var re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
  }

  function isValidPhone(phone) {
    // Accept digits and common separators; count digits (local phone length between 7 and 15)
    var digits = (phone || "").replace(/\D/g, "");
    return digits.length >= 7 && digits.length <= 15;
  }

  function isProbablyGibberish(s) {
    if (!s) return false;
    s = s.trim();
    if (s.length < 8) return false; // short strings are fine
    var lettersOnly = (s.match(/[a-zA-Z]/g) || []).join("");
    if (lettersOnly.length < 5) return false; // too few letters to judge
    var vowels = (lettersOnly.match(/[aeiouAEIOU]/g) || []).length;
    var vowelRatio = vowels / (lettersOnly.length || 1);
    // Suspicious if very low vowel ratio (many consonants, like random tokens)
    if (vowelRatio < 0.15) return true;
    // Also suspicious if there's no whitespace in a long field and vowel ratio low
    if (s.indexOf(" ") === -1 && vowelRatio < 0.2) return true;
    return false;
  }

  document
    .getElementById("contact-form")
    .addEventListener("submit", function (event) {
      event.preventDefault();

      // Validate form fields
      var name = document.getElementsByName("name")[0].value.trim();
      var email = document.getElementsByName("email")[0].value.trim();
      var phone = document.getElementsByName("phone")[0].value.trim();
      var subject = document.getElementsByName("subject")[0].value.trim();
      var message = document.getElementsByName("message")[0].value.trim();
      var honeypot = document.getElementsByName("company")[0]
        ? document.getElementsByName("company")[0].value.trim()
        : "";

      // Silent block if honeypot is filled (likely bot)
      if (honeypot) {
        console.warn("Honeypot filled â€” suspected bot submission blocked.");
        return;
      }

      if (!name || !email || !phone || !subject || !message) {
        Swal.fire({
          icon: "error",
          title: "Missing Fields",
          text: "Please fill in all required fields.",
        });
        return;
      }

      // Field-specific validations
      if (!isValidEmail(email)) {
        Swal.fire({
          icon: "error",
          title: "Invalid Email",
          text: "Please enter a valid email address.",
        });
        return;
      }

      if (!isValidPhone(phone)) {
        Swal.fire({
          icon: "error",
          title: "Invalid Phone Number",
          text: "Please enter a valid phone number (digits only, 7-15 digits).",
        });
        return;
      }

      // Reject gibberish submissions
      if (
        isProbablyGibberish(name) ||
        isProbablyGibberish(subject) ||
        isProbablyGibberish(message) ||
        message.length < 10
      ) {
        Swal.fire({
          icon: "error",
          title: "Invalid Content",
          text: "Please provide a clear, meaningful message and subject.",
        });
        return;
      }

      // Show loading alert
      var loadingAlert = Swal.fire({
        title: "Sending Message...",
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });

      // Execute reCAPTCHA v3 (api.js loaded with ?render=SITE_KEY)
      if (typeof grecaptcha !== "undefined") {
        grecaptcha.ready(function () {
          // Add a safety timeout in case reCAPTCHA stalls
          var recaptchaTimeout = setTimeout(function () {
            Swal.close();
            Swal.fire({
              icon: "error",
              title: "Timeout",
              text: "reCAPTCHA verification timed out. Please try again.",
              confirmButtonColor: "#d33",
            });
          }, 20000); // 20s timeout

          grecaptcha
            .execute("6LfhOiAsAAAAAAD5fU4kNUvIdl_R0_JTZ9W-eocq", {
              action: "submit",
            })
            .then(function (token) {
              clearTimeout(recaptchaTimeout);
              // store token into hidden input (optional) for debugging/inspection
              var tokenField = document.getElementById("recaptcha_token");
              if (tokenField) tokenField.value = token;

              // Get the form data
              var templateParams = {
                name: name,
                email: email,
                phone: phone,
                subject: subject,
                message: message,
                recaptcha_token: token,
              };

              // Send the email using emailjs
              emailjs
                .send("service_cpapaz9", "template_k6mstcn", templateParams)
                .then(
                  function (response) {
                    Swal.close();
                    Swal.fire({
                      icon: "success",
                      title: "Message Sent!",
                      text: "Your message has been sent successfully. Thank you!",
                      confirmButtonColor: "#3085d6",
                    });
                    document.getElementById("contact-form").reset();
                  },
                  function (error) {
                    Swal.close();
                    Swal.fire({
                      icon: "error",
                      title: "Failed to Send",
                      text: "There was an error sending your message. Please try again later.",
                      confirmButtonColor: "#d33",
                    });
                    console.error("EmailJS error:", error);
                  }
                )
                .catch(function (err) {
                  Swal.close();
                  Swal.fire({
                    icon: "error",
                    title: "Send Error",
                    text: "An unexpected error occurred. Please try again.",
                    confirmButtonColor: "#d33",
                  });
                  console.error("EmailJS unexpected error:", err);
                });
            })
            .catch(function (error) {
              clearTimeout(recaptchaTimeout);
              Swal.close();
              Swal.fire({
                icon: "error",
                title: "reCAPTCHA Error",
                text: "Failed to verify reCAPTCHA. Please try again.",
                confirmButtonColor: "#d33",
              });
              console.error("reCAPTCHA error:", error);
            });
        });
      } else {
        Swal.close();
        Swal.fire({
          icon: "error",
          title: "Security Error",
          text: "reCAPTCHA failed to load. Ensure your site key and domains are configured correctly.",
          confirmButtonColor: "#d33",
        });
      }
    });
</script>
